# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf

# ===============================
# 0ï¸âƒ£ ç³»çµ±è¨­å®š
# ===============================
CACHE_TTL = 300
TOP_N = 5
TRADING_DAYS = 252
ETF_RANK_URL = "https://tw.stock.yahoo.com/tw-etf/volume"  # æˆäº¤é‡æ’è¡Œ

# ===============================
# 1ï¸âƒ£ æŠ“ç†±é–€ ETFï¼ˆæˆäº¤é‡æ’è¡Œï¼‰
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_top_etf_by_volume(limit=15):
    try:
        tables = pd.read_html(ETF_RANK_URL)
        if not tables:
            return []
        df = tables[0]
        df["ä»£ç¢¼"] = df.iloc[:, 1].astype(str).str.extract(r"([0-9]{3,5})")[0]
        df = df.dropna(subset=["ä»£ç¢¼"])
        return df["ä»£ç¢¼"].unique()[:limit].tolist()
    except ImportError as e:
        st.error("âŒ è®€å– ETF æ’è¡Œè¡¨éœ€è¦ lxml/html5libï¼Œè«‹å®‰è£å¥—ä»¶ï¼špip install lxml html5lib")
        return []
    except Exception as e:
        st.warning(f"âš ï¸ å–å¾—ç†±é–€ ETF å¤±æ•—ï¼š{e}")
        return []

# ===============================
# 2ï¸âƒ£ æŠ“ Yahoo Finance æ­·å²è³‡æ–™
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_price_history(code: str) -> pd.Series:
    try:
        data = yf.download(f"{code}.TW", period="3y", progress=False)
        if data.empty:
            return pd.Series(dtype=float)
        if "Adj Close" in data.columns:
            return data["Adj Close"].dropna()
        elif ("Adj Close", "") in data.columns:
            return data[("Adj Close","")].dropna()
        return pd.Series(dtype=float)
    except Exception:
        return pd.Series(dtype=float)

# ===============================
# 3ï¸âƒ£ é¢¨éšªæŒ‡æ¨™è¨ˆç®—
# ===============================
def calculate_risk_metrics(price: pd.Series):
    if price.empty or len(price) < 2:
        return 0.0, 0.0
    returns = price.pct_change().dropna()
    volatility = returns.std() * np.sqrt(TRADING_DAYS)
    drawdown = (price / price.cummax() - 1).min()
    return round(volatility,4), round(abs(drawdown),4)

# ===============================
# 4ï¸âƒ£ å»ºç«‹ ETF DataFrame
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def build_etf_dataframe(top_etfs):
    rows = []
    for code in top_etfs:
        price = fetch_price_history(code)
        vol, mdd = calculate_risk_metrics(price)
        rows.append({
            "ä»£ç¢¼": code,
            "å¹´åŒ–æ³¢å‹•åº¦": vol,
            "æœ€å¤§å›æ’¤": mdd
        })
    df = pd.DataFrame(rows)
    df.fillna(0, inplace=True)
    return df

# ===============================
# 5ï¸âƒ£ Î¸-model
# ===============================
def calculate_theta(age, horizon, loss_tol, market_react):
    theta = (
        -0.03 * (age - 40)
        + 0.04 * horizon
        + 0.05 * (loss_tol - 15)
        + {"ç«‹å³è³£å‡º": -1, "æŒæœ‰è§€æœ›": 0, "é€¢ä½åŠ ç¢¼": 1.2}[market_react]
    )
    return round(theta, 2)

# ===============================
# 6ï¸âƒ£ é¢¨éšªæŒ‡æ•¸
# ===============================
def compute_etf_risk_index(row):
    type_risk = 0.6
    score = 0.4 * type_risk + 0.3 * row["å¹´åŒ–æ³¢å‹•åº¦"] + 0.3 * row["æœ€å¤§å›æ’¤"]
    return round(score,3)

# ===============================
# 7ï¸âƒ£ Streamlit UI
# ===============================
st.set_page_config(page_title="å°ç£ ETF æ™ºæ…§æ’åº", layout="wide")
st.title("ğŸ“Š è‡ªå‹•æŠ“ç†±é–€ ETF Ã— é¢¨éšªæ’åºæ¨è–¦ç³»çµ±")

cols = st.columns(4)
age = cols[0].slider("ğŸ‘¤ å¹´é½¡", 20, 80, 35)
horizon = cols[1].slider("â³ æŠ•è³‡å¹´é™", 1, 40, 10)
loss_tol = cols[2].slider("ğŸ’¥ æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
market_react = cols[3].radio("ğŸ“‰ å¸‚å ´ä¸‹è·Œ 20%", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

if st.button("ğŸ“¡ æŠ“ç†±é–€ ETF"):
    top_etfs = fetch_top_etf_by_volume(15)
    if top_etfs:
        st.write("ğŸ“ˆ æˆäº¤é‡æ’è¡Œç†±é–€ ETFï¼ˆå‰ 15ï¼‰:", top_etfs)
    else:
        st.warning("âš ï¸ ç„¡æ³•å–å¾—ç†±é–€ ETFï¼Œè«‹ç¢ºèª lxml/html5lib å·²å®‰è£æˆ–ç¶²è·¯æ­£å¸¸")

if st.button("ğŸš€ è¨ˆç®—ä¸¦æ¨è–¦ ETF"):
    top_etfs = fetch_top_etf_by_volume(15)
    if not top_etfs:
        st.error("âŒ ç„¡æ³•å–å¾—ç†±é–€ ETFï¼Œè«‹å…ˆå®‰è£ lxml/html5libï¼Œæˆ–ç¢ºèªç¶²è·¯é€£ç·š")
    else:
        etfs = build_etf_dataframe(top_etfs)
        if etfs.empty:
            st.warning("âš ï¸ ETF DataFrame ç‚ºç©ºï¼Œç„¡æ³•è¨ˆç®—")
        else:
            etfs["ETF é¢¨éšªæŒ‡æ•¸"] = etfs.apply(compute_etf_risk_index, axis=1)
            theta = calculate_theta(age, horizon, loss_tol, market_react)
            etfs["èˆ‡æŠ•è³‡äººè·é›¢"] = (etfs["ETF é¢¨éšªæŒ‡æ•¸"] - theta).abs()
            st.subheader(f"ğŸ“Š æŠ•è³‡äºº Î¸ å€¼ï¼š{theta}")
            st.dataframe(
                etfs.sort_values("èˆ‡æŠ•è³‡äººè·é›¢").head(TOP_N),
                use_container_width=True
            )

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo å¥‡æ‘©è‚¡å¸‚æˆäº¤é‡æ’è¡Œï½œæ­·å²åƒ¹æ ¼ä¾†æº Yahoo Financeï½œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡éœ€è‡ªè² é¢¨éšª")
