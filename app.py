# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf

# ===============================
# 0ï¸âƒ£ ç³»çµ±è¨­å®š
# ===============================
CACHE_TTL = 300
TOP_N = 5
TRADING_DAYS = 252

# ===============================
# 1ï¸âƒ£ ETF éœæ…‹è³‡æ–™
# ===============================
ETF_BASE_INFO = {
    '0050': ('å…ƒå¤§å°ç£50', 'è‚¡ç¥¨å‹', 3.3),
    '006208': ('å¯Œé‚¦å°50', 'è‚¡ç¥¨å‹', 3.5),
    '00713': ('å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢', 'é«˜è‚¡æ¯å‹', 9.8),
    '00878': ('åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', 'é«˜è‚¡æ¯å‹', 8.5),
    '0056': ('å…ƒå¤§é«˜è‚¡æ¯', 'é«˜è‚¡æ¯å‹', 7.2),
    '00692': ('å¯Œé‚¦å…¬å¸æ²»ç†100', 'è‚¡ç¥¨å‹', 6.5),
    '00900': ('å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30', 'é«˜è‚¡æ¯å‹', 9.5),
    '00695B': ('å¯Œé‚¦ç¾å‚µ7-10å¹´', 'å‚µåˆ¸å‹', 3.2),
    '00794B': ('ç¾¤ç›Šä¸­åœ‹æ”¿é‡‘å‚µ', 'å‚µåˆ¸å‹', 3.5),
    '00772B': ('ä¸­ä¿¡æŠ•è³‡ç´šå…¬å¸å‚µ', 'å‚µåˆ¸å‹', 4.0),
    '00757': ('çµ±ä¸€FANG+', 'è‚¡ç¥¨å‹', 0.5),
}

# ===============================
# 2ï¸âƒ£ æŠ“ Yahoo Finance æ­·å²è³‡æ–™
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def fetch_price_history(code: str) -> pd.Series:
    data = yf.download(f"{code}.TW", period="3y", progress=False)
    if data.empty:
        return pd.Series(dtype=float)
    return data["Adj Close"].dropna()

# ===============================
# 3ï¸âƒ£ é¢¨éšªæŒ‡æ¨™è¨ˆç®—
# ===============================
def calculate_risk_metrics(price: pd.Series):
    returns = price.pct_change().dropna()
    if returns.empty:
        return np.nan, np.nan

    volatility = returns.std() * np.sqrt(TRADING_DAYS)
    drawdown = (price / price.cummax() - 1).min()
    return volatility, abs(drawdown)

# ===============================
# 4ï¸âƒ£ å»ºç«‹ ETF DataFrameï¼ˆå³æ™‚ï¼‰
# ===============================
@st.cache_data(ttl=CACHE_TTL)
def build_etf_dataframe():
    rows = []

    for code, (name, etf_type, div_yield) in ETF_BASE_INFO.items():
        price = fetch_price_history(code)
        vol, mdd = calculate_risk_metrics(price)

        rows.append({
            "ä»£ç¢¼": code,
            "åç¨±": name,
            "å‹æ…‹": etf_type,
            "é…æ¯ç‡": div_yield,
            "å¹´åŒ–æ³¢å‹•åº¦": vol,
            "æœ€å¤§å›æ’¤": mdd
        })

    df = pd.DataFrame(rows).dropna()
    return df

# ===============================
# 5ï¸âƒ£ è¡Œç‚ºé‡‘è Î¸-model
# ===============================
def calculate_theta(age, horizon, loss_tol, market_react):
    theta = (
        -0.03 * (age - 40)
        + 0.04 * horizon
        + 0.05 * (loss_tol - 15)
        + {"ç«‹å³è³£å‡º": -1, "æŒæœ‰è§€æœ›": 0, "é€¢ä½åŠ ç¢¼": 1.2}[market_react]
    )
    return round(theta, 2)

# ===============================
# 6ï¸âƒ£ MCDA ETF é¢¨éšªæŒ‡æ•¸
# ===============================
def compute_etf_risk_index(row):
    type_risk = {"å‚µåˆ¸å‹": 0.2, "é«˜è‚¡æ¯å‹": 0.5, "è‚¡ç¥¨å‹": 0.8}.get(row["å‹æ…‹"], 0.9)

    score = (
        0.4 * type_risk +
        0.3 * row["å¹´åŒ–æ³¢å‹•åº¦"] +
        0.3 * row["æœ€å¤§å›æ’¤"]
    )
    return round(score, 3)

# ===============================
# 7ï¸âƒ£ Streamlit UI
# ===============================
st.title("ğŸ† å°ç£ ETF å³æ™‚é¢¨éšª Ã— MCDA æ™ºæ…§æ’åºç³»çµ±")

if st.button("ğŸ“¡ é‡æ–°æŠ“å– Yahoo Finance"):
    st.cache_data.clear()
    st.rerun()

cols = st.columns(4)
age = cols[0].slider("ğŸ‘¤ å¹´é½¡", 20, 80, 35)
horizon = cols[1].slider("â³ æŠ•è³‡å¹´é™", 1, 40, 10)
loss_tol = cols[2].slider("ğŸ’¥ æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
market_react = cols[3].radio("ğŸ“‰ å¸‚å ´ä¸‹è·Œ 20%", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

if st.button("ğŸš€ è¨ˆç®— ETF æ’åº"):
    theta = calculate_theta(age, horizon, loss_tol, market_react)

    etfs = build_etf_dataframe()
    etfs["ETFé¢¨éšªæŒ‡æ•¸"] = etfs.apply(compute_etf_risk_index, axis=1)
    etfs["èˆ‡æŠ•è³‡äººè·é›¢"] = (etfs["ETFé¢¨éšªæŒ‡æ•¸"] - theta).abs()

    st.subheader(f"ğŸ“Š æŠ•è³‡äºº Î¸ å€¼ï¼š{theta}")
    st.subheader("ğŸ¯ Top ETF å»ºè­°ï¼ˆMCDA æ’åºï¼‰")

    st.dataframe(
        etfs.sort_values("èˆ‡æŠ•è³‡äººè·é›¢").head(TOP_N),
        use_container_width=True
    )

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo Financeï½œé¢¨éšªæŒ‡æ¨™ç‚ºæœ¬ç ”ç©¶è‡ªè¡Œè¨ˆç®—")
