# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y1jRJvzhlUjdd66vnUOBj57YzwXHYc1s
"""

# app.py
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
from datetime import datetime, timedelta
import altair as alt

st.set_page_config(page_title="ETF å€‹äººåŒ–æ¨è–¦ (Altair ç‰ˆæœ¬)", layout="wide")
st.title("ğŸ“Š ETF å€‹äººåŒ–æ¨è–¦æ’åºï¼ˆSharpe + Î¸-model + Betaï¼‰")

# -------------------------------
# åƒæ•¸è¨­å®š
# -------------------------------
CACHE_TTL = 300
TOP_N = 5
TRADING_DAYS = 252
RISK_FREE_RATE = 0.017  # å‡è¨­ç„¡é¢¨éšªåˆ©ç‡ 1.7%

# -------------------------------
# ETF åˆ—è¡¨èˆ‡å‹æ…‹
# -------------------------------
ETF_LIST = ["0050.TW","0056.TW","006208.TW","00713.TW","00878.TW","00692.TW","00900.TW","00695B.TW","00794B.TW","00772B.TW","00757.TW"]
ETF_TYPE_MAPPING = {
    "0050.TW": "è‚¡ç¥¨å‹",
    "0056.TW": "é«˜è‚¡æ¯å‹",
    "006208.TW": "è‚¡ç¥¨å‹",
    "00713.TW": "é«˜è‚¡æ¯å‹",
    "00878.TW": "é«˜è‚¡æ¯å‹",
    "00692.TW": "è‚¡ç¥¨å‹",
    "00900.TW": "é«˜è‚¡æ¯å‹",
    "00695B.TW": "å‚µåˆ¸å‹",
    "00794B.TW": "å‚µåˆ¸å‹",
    "00772B.TW": "å‚µåˆ¸å‹",
    "00757.TW": "è‚¡ç¥¨å‹",
}

# -------------------------------
# ä½¿ç”¨è€…è¼¸å…¥
# -------------------------------
st.subheader("ğŸ‘¤ è«‹è¼¸å…¥æ‚¨çš„æŠ•è³‡åå¥½")
cols = st.columns(6)
age = cols[0].slider("å¹´é½¡", 20, 80, 35)
horizon = cols[1].slider("æŠ•è³‡å¹´é™", 1, 40, 10)
loss_tol = cols[2].slider("æœ€å¤§å¯æ¥å—æå¤± (%)", 0, 50, 15)
expected_return = cols[3].slider("é æœŸå ±é…¬ (%)", 0, 50, 10)
expected_dividend = cols[4].slider("æœŸæœ›é…æ¯ (%)", 0, 50, 3)
market_react = cols[5].radio("å¸‚å ´ä¸‹è·Œ 20% æ‚¨æœƒæ€éº¼åš", ["ç«‹å³è³£å‡º","æŒæœ‰è§€æœ›","é€¢ä½åŠ ç¢¼"])

# -------------------------------
# Î¸-model è¨ˆç®—
# åƒè€ƒå­¸è¡“æ–‡ç»ï¼šWeber & Milliman (1997), Grable & Lytton (1999)
# -------------------------------
def calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend):
    """
    Î¸-model: å°‡ä½¿ç”¨è€…å¹´é½¡ã€æŠ•è³‡ç¶“é©—ã€é¢¨éšªæ‰¿å—åº¦ç­‰æ•¸æ“šåŒ–ç‚º -2 ~ +2 ç¯„åœ
    """
    market_map = {"ç«‹å³è³£å‡º":-1,"æŒæœ‰è§€æœ›":0,"é€¢ä½åŠ ç¢¼":1.2}
    theta_raw = (
        -0.03*(age-40) +
        0.04*horizon +
        0.05*(loss_tol-15) +
        market_map[market_react] +
        0.03*expected_return +
        0.02*expected_dividend
    )
    theta = np.clip(theta_raw/2, -2, 2)  # é™åˆ¶åœ¨ -2 ~ +2
    return round(theta,2)

theta_value = calculate_theta(age,horizon,loss_tol,market_react,expected_return,expected_dividend)
st.info(f"æ‚¨çš„ Î¸ å€¼ï¼ˆé¢¨éšªæ‰¿å—æŒ‡æ•¸ï¼‰ï¼š{theta_value}")

# -------------------------------
# æŠ“å– ETF è³‡æ–™ï¼ˆYahoo Finance fallbackï¼‰
# -------------------------------
@st.cache_data(ttl=CACHE_TTL)
def fetch_etf_data(etf_list):
    etf_info_list = []
    for code in etf_list:
        try:
            ticker = yf.Ticker(code)
            hist = ticker.history(period="1y")
            if hist.empty:
                continue
            price_now = hist["Close"].iloc[-1]

            # è‚¡æ¯
            divs = hist["Dividends"].fillna(0)
            total_div = divs.sum()
            annual_div = total_div*(TRADING_DAYS/len(hist))
            recent_div = divs[divs>0]
            latest_div_val = recent_div.iloc[-1] if not recent_div.empty else 0.0
            latest_div_date = recent_div.index[-1].strftime("%Y-%m-%d") if not recent_div.empty else "N/A"

            # æ—¥æ”¶ç›Šç‡
            hist["return"] = hist["Close"].pct_change()
            mu = hist["return"].mean()*TRADING_DAYS
            sigma = hist["return"].std()*np.sqrt(TRADING_DAYS)
            sharpe = (mu - RISK_FREE_RATE)/sigma if sigma>0 else 0.0

            # Beta ç›¸å°æ–¼å¤§ç›¤ 0050.TW
            try:
                sp500 = yf.Ticker("0050.TW").history(period="1y")
                sp500["return"] = sp500["Close"].pct_change()
                cov = np.cov(hist["return"].iloc[1:], sp500["return"].iloc[1:])[0,1]
                beta = cov / np.var(sp500["return"].iloc[1:]) if np.var(sp500["return"].iloc[1:])>0 else 1.0
            except:
                beta = 1.0

            etf_info_list.append({
                "ä»£ç¢¼": code,
                "å‹æ…‹": ETF_TYPE_MAPPING.get(code,"æœªçŸ¥å‹æ…‹"),
                "å³æ™‚åƒ¹": round(price_now,2),
                "å¹´åŒ–é…æ¯ç‡ (%)": round(annual_div/price_now*100,2),
                "æœ€æ–°é™¤æ¯é‡‘é¡": round(latest_div_val,2),
                "æœ€æ–°é™¤æ¯æ—¥": latest_div_date,
                "Sharpe Ratio": round(sharpe,2),
                "Beta": round(beta,2)
            })
        except:
            continue
    return pd.DataFrame(etf_info_list)

# -------------------------------
# è¨ˆç®—å€‹äººåŒ–åˆ†æ•¸
# -------------------------------
def compute_personal_score(row, theta):
    """
    å€‹äººåŒ–åˆ†æ•¸ = Sharpe - abs(Î¸ - Beta)
    è¶Šæ¥è¿‘ä½¿ç”¨è€…é¢¨éšªåå¥½ï¼Œåˆ†æ•¸è¶Šé«˜
    """
    score = row["Sharpe Ratio"] - abs(theta - row["Beta"])
    return round(score,3)

# -------------------------------
# é¡¯ç¤ºç†±é–€ ETFï¼ˆä¾ Sharpe æ’åºï¼‰
# -------------------------------
if st.button("ğŸ“¡ é¡¯ç¤ºç†±é–€ ETF"):
    df_etf = fetch_etf_data(ETF_LIST)
    if df_etf.empty:
        st.warning("âš  ç„¡æ³•å–å¾— ETF è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦")
    else:
        df_etf["ç†±é–€æ’å"] = df_etf["Sharpe Ratio"].rank(ascending=False)
        st.subheader("ğŸ”¥ å¸‚å ´ç†±é–€ ETFï¼ˆä¾ Sharpe æ’åºï¼‰")
        st.dataframe(df_etf.sort_values("ç†±é–€æ’å").reset_index(drop=True))

        # -------------------------------
        # å€‹äººåŒ–æ¨è–¦
        # -------------------------------
        df_etf["å€‹äººåŒ–åˆ†æ•¸"] = df_etf.apply(lambda row: compute_personal_score(row, theta_value), axis=1)
        df_etf = df_etf.sort_values("å€‹äººåŒ–åˆ†æ•¸", ascending=False).reset_index(drop=True)
        st.subheader("ğŸ¯ å€‹äººåŒ–æ¨è–¦ ETF")
        st.dataframe(df_etf.head(TOP_N))

        # -------------------------------
        # Altair é›·é”åœ–ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
        # -------------------------------
        radar_data = df_etf.head(TOP_N).melt(id_vars=["ä»£ç¢¼"], value_vars=["Sharpe Ratio","Beta","å¹´åŒ–é…æ¯ç‡ (%)"])
        radar_data = radar_data.rename(columns={"variable":"æŒ‡æ¨™","value":"æ•¸å€¼"})
        st.subheader("ğŸ“Š å€‹äººåŒ–æ¨è–¦æŒ‡æ¨™é›·é”åœ–")
        chart = alt.Chart(radar_data).mark_line(point=True).encode(
            x=alt.X("æŒ‡æ¨™:N"),
            y=alt.Y("æ•¸å€¼:Q"),
            color="ä»£ç¢¼:N",
            tooltip=["ä»£ç¢¼","æŒ‡æ¨™","æ•¸å€¼"]
        )
        st.altair_chart(chart, use_container_width=True)

st.info("ğŸ“Œ è³‡æ–™ä¾†æºï¼šYahoo Financeï½œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡éœ€è‡ªè² é¢¨éšª")
